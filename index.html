<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!doctype html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1">&lt;meta charset="utf-8" /&gt;</p>
<p class="p1">&lt;meta name="viewport" content="width=device-width,initial-scale=1" /&gt;</p>
<p class="p1">&lt;title&gt;Nightfall in Greyhaven — A Browser Board Game (Arkham-like)&lt;/title&gt;</p>
<p class="p1">&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>:root { --bg:#0b0f14; --panel:#121926; --ink:#e5f1ff; --muted:#94a3b8; --accent:#7dd3fc; --danger:#fca5a5; --ok:#86efac; --warn:#fde68a;}</p>
<p class="p1"><span class="Apple-converted-space">  </span>* { box-sizing: border-box; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>html, body { height:100%; margin:0; background:radial-gradient(1200px 600px at 70% -10%, #1f2937 0%, #0b0f14 60%); color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>header { padding:8px 12px; display:flex; align-items:center; gap:12px; background:#0b1220; border-bottom:1px solid #1f2937; position:sticky; top:0; z-index:5; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>header h1 { font-size:16px; margin:0; letter-spacing:.5px; color:#bde0fe; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>header .small { color:var(--muted); font-size:12px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>main { display:grid; grid-template-columns: 360px 1fr 320px; gap:12px; padding:12px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.panel { background:var(--panel); border:1px solid #1f2937; border-radius:10px; padding:10px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.panel h2 { font-size:14px; margin:0 0 8px 0; color:#c7d2fe; letter-spacing:.4px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>#leftcol { display:flex; flex-direction:column; gap:12px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>#players .row { display:flex; align-items:center; justify-content:space-between; padding:6px 8px; margin-bottom:6px; background:#0f172a; border:1px solid #1f2937; border-radius:8px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.tag { padding:2px 6px; border-radius:6px; font-size:11px; border:1px solid #374151; color:#cbd5e1;}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.btnbar { display:flex; flex-wrap:wrap; gap:6px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>button { background:#0f172a; color:var(--ink); border:1px solid #334155; border-radius:8px; padding:8px 10px; cursor:pointer; transition:.15s transform ease; font-weight:600; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>button:hover { transform:translateY(-1px); border-color:#64748b; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>button.primary { background:#0b3b53; border-color:#155e75; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>button.danger { background:#4a1d1d; border-color:#7f1d1d; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>#board { height: calc(100vh - 120px); min-height:520px; background:#0a0f17; border-radius:12px; position:relative; overflow:hidden; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>#grid { position:absolute; inset:10px; display:grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap:10px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.loc { position:relative; border:1px solid #273043; border-radius:10px; padding:8px; background:linear-gradient(180deg,#0e1624 0%,#0a1120 100%); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.loc h3 { margin:0 0 4px 0; font-size:13px; color:#a5b4fc; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.loc .info { font-size:11px; color:var(--muted); display:flex; gap:8px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.loc .tokens { position:absolute; right:6px; bottom:6px; display:flex; gap:4px; flex-wrap:wrap; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.token { width:22px; height:22px; border-radius:50%; display:grid; place-items:center; font-size:12px; border:2px solid #0b1220; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.token.gate { background:#1f2937; box-shadow:0 0 8px 2px #93c5fd55 inset, 0 0 6px 1px #93c5fd33; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.token.monst { background:#2b1b1b; box-shadow:0 0 8px 2px #f8717155 inset, 0 0 6px 1px #ef444433; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.token.clue { background:#153a2c; box-shadow:0 0 8px 2px #86efac55 inset; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.investigator { position:absolute; width:24px; height:24px; border-radius:50%; border:2px solid #000; background:#334155; display:grid; place-items:center; font-size:12px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>#rightcol { display:flex; flex-direction:column; gap:12px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>#log { height:220px; overflow:auto; background:#0b1220; padding:8px; border-radius:8px; border:1px solid #1f2937; font-size:13px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>#log p { margin:0 0 6px 0; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.doomtrack { display:flex; gap:4px; margin-top:6px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.doom { width:12px; height:12px; border-radius:3px; background:#1f2937; border:1px solid #374151; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.doom.on { background:linear-gradient(180deg,#7f1d1d,#ef4444); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.statrow { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.pill { border:1px solid #374151; border-radius:999px; padding:3px 8px; font-size:12px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.good { background:#052b1b; color:#bbf7d0; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.bad { background:#2a0c0c; color:#fecaca; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.neutral { background:#0b1322; color:#c7d2fe; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.muted { color:#9ca3af; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.sep { height:1px; background:#1f2937; margin:8px 0; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.grid2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>.kbd { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#111827; border:1px solid #374151; padding:1px 6px; border-radius:6px; font-size:12px; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>a { color:var(--accent); }</p>
<p class="p1">&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p1">&lt;header&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;h1&gt;Nightfall in Greyhaven&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div class="small"&gt;A compact, Arkham-style browser board game (original content). Hot-seat co-op for 1–4 players.&lt;/div&gt;</p>
<p class="p1">&lt;/header&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;main&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;section id="leftcol"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;h2&gt;Table Controls&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="btnbar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button class="primary" id="btn-new"&gt;New Game&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="btn-save"&gt;Save&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="btn-load"&gt;Load&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="btn-help"&gt;Help&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="sep"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="grid2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;h2&gt;Turn Phases&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;div class="btnbar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="btn-upkeep"&gt;Upkeep&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="btn-move"&gt;Move&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="btn-enc"&gt;Encounter&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="btn-mythos"&gt;Mythos&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;h2&gt;Actions&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;div class="btnbar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="btn-search"&gt;Search / Clue&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="btn-fight"&gt;Fight / Evade&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="btn-rest"&gt;Rest&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;button id="btn-endturn"&gt;End Turn ▶&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="players" class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;h2&gt;Investigators&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="playersList"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="sep"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="statrow"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="pill neutral"&gt;Phase: &lt;span id="ui-phase"&gt;Upkeep&lt;/span&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="pill good"&gt;Doom: &lt;span id="ui-doom"&gt;0&lt;/span&gt;/&lt;span id="ui-doommax"&gt;10&lt;/span&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="pill good"&gt;Clues: &lt;span id="ui-clues"&gt;0&lt;/span&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="pill bad"&gt;Monsters: &lt;span id="ui-monsters"&gt;0&lt;/span&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span class="pill neutral"&gt;Turn: &lt;span id="ui-turn"&gt;1&lt;/span&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="doomtrack" id="doomtrack"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/section&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;section class="panel" id="board"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="grid"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/section&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;section id="rightcol"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;h2&gt;Active Player&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="activeBox"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="sep"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="flex"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span&gt;Switch: &lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="switchers" class="btnbar"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;h2&gt;Mythos &amp; Agenda&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="agendaBox" class="muted" style="min-height:60px;"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="sep"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="btnbar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="btn-spawn"&gt;Spawn Gate&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="btn-dropclue"&gt;Drop Clue&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button class="danger" id="btn-advance"&gt;Advance Doom&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;h2&gt;Game Log&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="log"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/section&gt;</p>
<p class="p1">&lt;/main&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;script&gt;</p>
<p class="p1">/* ===========</p>
<p class="p1"><span class="Apple-converted-space">   </span>Nightfall in Greyhaven — compact Arkham-like in one file</p>
<p class="p1"><span class="Apple-converted-space">   </span>Original mechanics &amp; content. No copyrighted text or art.</p>
<p class="p1"><span class="Apple-converted-space">   </span>=========== */</p>
<p class="p2"><br></p>
<p class="p1">/*** Utilities ***/</p>
<p class="p1">const $ = (sel, el=document) =&gt; el.querySelector(sel);</p>
<p class="p1">const $$ = (sel, el=document) =&gt; [...el.querySelectorAll(sel)];</p>
<p class="p1">const rnd = (n) =&gt; Math.floor(Math.random()*n);</p>
<p class="p1">const clamp = (v,min,max)=&gt;Math.max(min,Math.min(max,v));</p>
<p class="p1">const dice = (count, target=5) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">  </span>let hits=0, rolls=[];</p>
<p class="p1"><span class="Apple-converted-space">  </span>for(let i=0;i&lt;count;i++){ const r=1+rnd(6); rolls.push(r); if(r&gt;=target) hits++; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>return {hits, rolls};</p>
<p class="p1">};</p>
<p class="p1">const log = (msg) =&gt; { const p=document.createElement('p'); p.innerHTML=msg; $("#log").prepend(p); };</p>
<p class="p2"><br></p>
<p class="p1">/*** Data ***/</p>
<p class="p1">const LOCS = [</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"train", name:"Greyhaven Station", trait:"Street", diff:2 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"uni", name:"Eldwood University", trait:"Academic", diff:3 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"harbor", name:"Blackwater Docks", trait:"Harbor", diff:3 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"theatre", name:"Orpheum Theatre", trait:"Society", diff:2 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"square", name:"Ashen Square", trait:"Street", diff:2 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"hospital", name:"St. Brigid Hospital", trait:"Sanctum", diff:2 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"museum", name:"Museum of Curios", trait:"Occult", diff:3 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"church", name:"Chapel of Lanterns", trait:"Sacred", diff:2 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ id:"cemetery", name:"Wraithwood Cemetery", trait:"Grave", diff:3 },</p>
<p class="p1">];</p>
<p class="p2"><br></p>
<p class="p1">const ENCOUNTERS = {</p>
<p class="p1"><span class="Apple-converted-space">  </span>Street: [</p>
<p class="p1"><span class="Apple-converted-space">    </span>"You hear whispers in the wind. Lose 1 Sanity unless you spend 1 Clue.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"A patrolman questions you. Pass Will(1) or discard 1 Item."</p>
<p class="p1"><span class="Apple-converted-space">  </span>],</p>
<p class="p1"><span class="Apple-converted-space">  </span>Academic: [</p>
<p class="p1"><span class="Apple-converted-space">    </span>"A dusty tome reveals sigils. Gain 1 Clue.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Professor needs help; pass Intellect(2) to draw a Spell."</p>
<p class="p1"><span class="Apple-converted-space">  </span>],</p>
<p class="p1"><span class="Apple-converted-space">  </span>Harbor: [</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Smuggler offers a relic. Pay 1 Health to gain 1 Item.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Thick fog: Evade test Agility(2) or become Delayed."</p>
<p class="p1"><span class="Apple-converted-space">  </span>],</p>
<p class="p1"><span class="Apple-converted-space">  </span>Society: [</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Secret society invites you. Pass Will(2) to gain Ally.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Charity gala distracts you: lose 1 Clue."</p>
<p class="p1"><span class="Apple-converted-space">  </span>],</p>
<p class="p1"><span class="Apple-converted-space">  </span>Sanctum: [</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Nurse heals you. Recover 2 Health.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Quiet ward unnerves you: lose 1 Sanity."</p>
<p class="p1"><span class="Apple-converted-space">  </span>],</p>
<p class="p1"><span class="Apple-converted-space">  </span>Occult: [</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Cursed idol hums. Gain 1 Spell then lose 1 Sanity.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Shadow clings to you. Will(3) or Doom +1."</p>
<p class="p1"><span class="Apple-converted-space">  </span>],</p>
<p class="p1"><span class="Apple-converted-space">  </span>Sacred: [</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Light pierces gloom. Recover 2 Sanity.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Confessional truth. Gain 1 Clue, then Doom +1 if you have a Spell."</p>
<p class="p1"><span class="Apple-converted-space">  </span>],</p>
<p class="p1"><span class="Apple-converted-space">  </span>Grave: [</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Ghast rises! Fight(2) or take 1 Health dmg.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Cold stones: Intellect(2) to find 1 Clue."</p>
<p class="p1"><span class="Apple-converted-space">  </span>]</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">const NAMES = [</p>
<p class="p1"><span class="Apple-converted-space">  </span>["Ruth Calder","Balanced","Will"],</p>
<p class="p1"><span class="Apple-converted-space">  </span>["Jonah Pike","Brawler","Fight"],</p>
<p class="p1"><span class="Apple-converted-space">  </span>["Elise Hart","Scholar","Intellect"],</p>
<p class="p1"><span class="Apple-converted-space">  </span>["Tamsin Vale","Rogue","Agility"]</p>
<p class="p1">];</p>
<p class="p2"><br></p>
<p class="p1">const MONSTERS = [</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ name:"Ghoul", fight:2, evade:2, hp:1, dmg:1, horror:1 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ name:"Witch", fight:3, evade:2, hp:2, dmg:1, horror:1 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ name:"Hound", fight:2, evade:3, hp:2, dmg:2, horror:0 },</p>
<p class="p1"><span class="Apple-converted-space">  </span>{ name:"Spawn", fight:4, evade:1, hp:3, dmg:2, horror:2 },</p>
<p class="p1">];</p>
<p class="p2"><br></p>
<p class="p1">const AGENDAS = [</p>
<p class="p1"><span class="Apple-converted-space">  </span>"Stars wheel into a crooked alignment. Gates open more often this turn.",</p>
<p class="p1"><span class="Apple-converted-space">  </span>"Tide of silence: Each Evade is +1 difficulty.",</p>
<p class="p1"><span class="Apple-converted-space">  </span>"Curtain of frost: Movement limited to 1 step this turn.",</p>
<p class="p1"><span class="Apple-converted-space">  </span>"Echoes from below: First Encounter this round adds Doom +1 on fail."</p>
<p class="p1">];</p>
<p class="p2"><br></p>
<p class="p1">/*** Game State ***/</p>
<p class="p1">const G = {</p>
<p class="p1"><span class="Apple-converted-space">  </span>players: [],</p>
<p class="p1"><span class="Apple-converted-space">  </span>active: 0,</p>
<p class="p1"><span class="Apple-converted-space">  </span>phase: "Upkeep",</p>
<p class="p1"><span class="Apple-converted-space">  </span>turn: 1,</p>
<p class="p1"><span class="Apple-converted-space">  </span>doom: 0,</p>
<p class="p1"><span class="Apple-converted-space">  </span>doomMax: 10,</p>
<p class="p1"><span class="Apple-converted-space">  </span>clues: 0,</p>
<p class="p1"><span class="Apple-converted-space">  </span>monsters: [],</p>
<p class="p1"><span class="Apple-converted-space">  </span>gates: [],</p>
<p class="p1"><span class="Apple-converted-space">  </span>delays: {}, // id -&gt; true</p>
<p class="p1"><span class="Apple-converted-space">  </span>agenda: null,</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">/*** Setup ***/</p>
<p class="p1">function createPlayers(n=2){</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.players = [];</p>
<p class="p1"><span class="Apple-converted-space">  </span>for(let i=0;i&lt;n;i++){</p>
<p class="p1"><span class="Apple-converted-space">    </span>const [name,arch,focus] = NAMES[i%NAMES.length];</p>
<p class="p1"><span class="Apple-converted-space">    </span>G.players.push({</p>
<p class="p1"><span class="Apple-converted-space">      </span>id: i,</p>
<p class="p1"><span class="Apple-converted-space">      </span>name,</p>
<p class="p1"><span class="Apple-converted-space">      </span>arch,</p>
<p class="p1"><span class="Apple-converted-space">      </span>focus,</p>
<p class="p1"><span class="Apple-converted-space">      </span>health: 7,</p>
<p class="p1"><span class="Apple-converted-space">      </span>sanity: 7,</p>
<p class="p1"><span class="Apple-converted-space">      </span>clues: 0,</p>
<p class="p1"><span class="Apple-converted-space">      </span>items: [],</p>
<p class="p1"><span class="Apple-converted-space">      </span>spells: [],</p>
<p class="p1"><span class="Apple-converted-space">      </span>loc: "square",</p>
<p class="p1"><span class="Apple-converted-space">      </span>delayed: false,</p>
<p class="p1"><span class="Apple-converted-space">      </span>stats: { Will:3, Fight:3, Intellect:3, Agility:3 }</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.active = 0;</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function resetBoard(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.monsters = [];</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.gates = [];</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.clues = 0;</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.doom = 0;</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.turn = 1;</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.phase = "Upkeep";</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.agenda = AGENDAS[rnd(AGENDAS.length)];</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.players.forEach(p=&gt;{ p.loc="square"; p.health=7; p.sanity=7; p.clues=0; p.items=[]; p.spells=[]; p.delayed=false; });</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">/*** Rendering ***/</p>
<p class="p1">function render(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>// Left panel stats</p>
<p class="p1"><span class="Apple-converted-space">  </span>$("#ui-phase").textContent = G.phase;</p>
<p class="p1"><span class="Apple-converted-space">  </span>$("#ui-doom").textContent = G.doom;</p>
<p class="p1"><span class="Apple-converted-space">  </span>$("#ui-doommax").textContent = G.doomMax;</p>
<p class="p1"><span class="Apple-converted-space">  </span>$("#ui-clues").textContent = G.clues;</p>
<p class="p1"><span class="Apple-converted-space">  </span>$("#ui-monsters").textContent = G.monsters.length;</p>
<p class="p1"><span class="Apple-converted-space">  </span>$("#ui-turn").textContent = G.turn;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Doom track</p>
<p class="p1"><span class="Apple-converted-space">  </span>const dt = $("#doomtrack");</p>
<p class="p1"><span class="Apple-converted-space">  </span>dt.innerHTML = "";</p>
<p class="p1"><span class="Apple-converted-space">  </span>for(let i=0;i&lt;G.doomMax;i++){</p>
<p class="p1"><span class="Apple-converted-space">    </span>const d=document.createElement('div'); d.className='doom'+(i&lt;G.doom?' on':''); dt.appendChild(d);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Players list</p>
<p class="p1"><span class="Apple-converted-space">  </span>const pl = $("#playersList"); pl.innerHTML="";</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.players.forEach((p,idx)=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">    </span>const row=document.createElement('div'); row.className='row';</p>
<p class="p1"><span class="Apple-converted-space">    </span>row.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div&gt;&lt;strong&gt;${p.name}&lt;/strong&gt; &lt;span class="tag"&gt;${p.arch}&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="muted" style="font-size:12px;"&gt;HP ${p.health} • SAN ${p.sanity} • Clues ${p.clues} • ${locById(p.loc).name}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div&gt;&lt;span class="tag"&gt;${idx===G.active?'Active':''}&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>`;</p>
<p class="p1"><span class="Apple-converted-space">    </span>pl.appendChild(row);</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Active</p>
<p class="p1"><span class="Apple-converted-space">  </span>const ap = G.players[G.active];</p>
<p class="p1"><span class="Apple-converted-space">  </span>$("#activeBox").innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="statrow"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="pill neutral"&gt;&lt;strong&gt;${ap.name}&lt;/strong&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="pill"&gt;Focus: ${ap.focus}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="statrow" style="margin-top:6px;"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="pill ${ap.health&lt;=3?'bad':'good'}"&gt;Health: ${ap.health}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="pill ${ap.sanity&lt;=3?'bad':'good'}"&gt;Sanity: ${ap.sanity}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="pill neutral"&gt;Clues: ${ap.clues}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="muted" style="margin-top:8px;"&gt;Items: ${ap.items.join(', ')||'—'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="muted"&gt;Spells: ${ap.spells.join(', ')||'—'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="muted"&gt;Location: ${locById(ap.loc).name}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Switchers</p>
<p class="p1"><span class="Apple-converted-space">  </span>const sw=$("#switchers"); sw.innerHTML="";</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.players.forEach((p,idx)=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">    </span>const b=document.createElement('button'); b.textContent=`P${idx+1}`; if(idx===G.active) b.classList.add('primary');</p>
<p class="p1"><span class="Apple-converted-space">    </span>b.onclick=()=&gt;{ G.active=idx; render(); };</p>
<p class="p1"><span class="Apple-converted-space">    </span>sw.appendChild(b);</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Agenda</p>
<p class="p1"><span class="Apple-converted-space">  </span>$("#agendaBox").textContent = G.agenda || "—";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Board grid</p>
<p class="p1"><span class="Apple-converted-space">  </span>const grid=$("#grid"); grid.innerHTML="";</p>
<p class="p1"><span class="Apple-converted-space">  </span>LOCS.forEach((L,i)=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">    </span>const cell=document.createElement('div'); cell.className='loc';</p>
<p class="p1"><span class="Apple-converted-space">    </span>const mHere = G.monsters.filter(m=&gt;m.loc===L.id).length;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const gHere = G.gates.includes(L.id);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const cluesHere = cluesAt(L.id);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>cell.innerHTML = `</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;h3&gt;${L.name}&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="info"&gt;&lt;span&gt;${L.trait}&lt;/span&gt;&lt;span&gt;Diff ${L.diff}&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="tokens"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>`;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const t = $(".tokens", cell);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (gHere){ const a=token('gate','G'); t.appendChild(a); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>for(let k=0;k&lt;mHere;k++){ t.appendChild(token('monst','M')); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>for(let k=0;k&lt;cluesHere;k++){ t.appendChild(token('clue','C')); }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Player pawns</p>
<p class="p1"><span class="Apple-converted-space">    </span>G.players.forEach((p,idx)=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(p.loc===L.id){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const iv=document.createElement('div'); iv.className='investigator'; iv.style.left = (8+idx*26)+'px'; iv.style.top=(60)+'px';</p>
<p class="p1"><span class="Apple-converted-space">        </span>iv.textContent = (idx+1);</p>
<p class="p1"><span class="Apple-converted-space">        </span>iv.title = p.name;</p>
<p class="p1"><span class="Apple-converted-space">        </span>cell.appendChild(iv);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Click to move active during Move phase</p>
<p class="p1"><span class="Apple-converted-space">    </span>cell.onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(G.phase!=="Move"){ log(`&lt;span class="muted"&gt;You can only relocate during the Move phase.&lt;/span&gt;`); return; }</p>
<p class="p1"><span class="Apple-converted-space">      </span>moveActiveTo(L.id);</p>
<p class="p1"><span class="Apple-converted-space">    </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>grid.appendChild(cell);</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function token(cls, label){</p>
<p class="p1"><span class="Apple-converted-space">  </span>const e=document.createElement('div'); e.className='token '+cls; e.textContent=label; return e;</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function locById(id){ return LOCS.find(L=&gt;L.id===id); }</p>
<p class="p1">function locRandom(){ return LOCS[rnd(LOCS.length)]; }</p>
<p class="p1">function cluesAt(id){ return (G._cluesByLoc &amp;&amp; G._cluesByLoc[id])||0; }</p>
<p class="p1">function addClue(id){ if(!G._cluesByLoc) G._cluesByLoc={}; G._cluesByLoc[id]=(G._cluesByLoc[id]||0)+1; G.clues++; }</p>
<p class="p1">function takeClue(id){ if(!G._cluesByLoc) return false; if((G._cluesByLoc[id]||0)&gt;0){ G._cluesByLoc[id]--; G.clues= Math.max(0,G.clues-1); return true; } return false; }</p>
<p class="p2"><br></p>
<p class="p1">/*** Actions ***/</p>
<p class="p1">function moveActiveTo(id){</p>
<p class="p1"><span class="Apple-converted-space">  </span>const p=G.players[G.active];</p>
<p class="p1"><span class="Apple-converted-space">  </span>// Basic rule: can move 2 spaces per Move unless delayed or agenda says 1</p>
<p class="p1"><span class="Apple-converted-space">  </span>let maxSteps = 2;</p>
<p class="p1"><span class="Apple-converted-space">  </span>if((G.agenda||"").includes("limited to 1")) maxSteps=1;</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(p.delayed){ log(`${p.name} is Delayed and stands up instead of moving.`); p.delayed=false; render(); return; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Simple distance: allow move always but consume 1 move; we track only once per Move click for this compact version</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(p._movedSteps==null) p._movedSteps=0;</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(p._movedSteps&gt;=maxSteps){ log(`${p.name} has no movement left.`); return; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>p.loc = id;</p>
<p class="p1"><span class="Apple-converted-space">  </span>p._movedSteps++;</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;strong&gt;${p.name}&lt;/strong&gt; moves to &lt;em&gt;${locById(id).name}&lt;/em&gt;.`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function doUpkeep(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.phase="Upkeep";</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.players.forEach(p=&gt;{ p._movedSteps=0; });</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;strong&gt;Upkeep:&lt;/strong&gt; Refresh, adjust, ready.`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p1">function doMove(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.phase="Move";</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;strong&gt;Move:&lt;/strong&gt; Each investigator may move up to 2 spaces${(G.agenda||"").includes("limited to 1")?" (limited to 1 by Agenda)":"."}`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p1">function doEncounter(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.phase="Encounter";</p>
<p class="p1"><span class="Apple-converted-space">  </span>const p=G.players[G.active];</p>
<p class="p1"><span class="Apple-converted-space">  </span>const L=locById(p.loc);</p>
<p class="p1"><span class="Apple-converted-space">  </span>const trait = L.trait;</p>
<p class="p1"><span class="Apple-converted-space">  </span>const pool = ENCOUNTERS[trait] || ["Nothing happens."];</p>
<p class="p1"><span class="Apple-converted-space">  </span>const text = pool[rnd(pool.length)];</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;strong&gt;Encounter (${L.name}):&lt;/strong&gt; ${text}`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>resolveEncounter(p, L, text);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p1">function doMythos(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.phase="Mythos";</p>
<p class="p1"><span class="Apple-converted-space">  </span>// Spawn Gate 60% chance, Monster 70% chance, Clue 60% chance, Doom 25% baseline</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(Math.random()&lt;0.6) spawnGate();</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(Math.random()&lt;0.7) spawnMonster();</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(Math.random()&lt;0.6) dropClue();</p>
<p class="p1"><span class="Apple-converted-space">  </span>let doomOdds = 0.25 + (G.gates.length*0.05);</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(Math.random()&lt;doomOdds) advanceDoom();</p>
<p class="p1"><span class="Apple-converted-space">  </span>moveMonsters();</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.turn++;</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;strong&gt;Mythos resolves.&lt;/strong&gt; Turn advances to &lt;strong&gt;${G.turn}&lt;/strong&gt;.`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.phase="Upkeep";</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p1">function dropClue(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>const L = locRandom().id; addClue(L);</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`A clue appears at &lt;em&gt;${locById(L).name}&lt;/em&gt;.`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p1">function spawnGate(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>const L = locRandom().id;</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(!G.gates.includes(L)){</p>
<p class="p1"><span class="Apple-converted-space">    </span>G.gates.push(L);</p>
<p class="p1"><span class="Apple-converted-space">    </span>log(`&lt;span class="bad"&gt;A gate yawns open at &lt;em&gt;${locById(L).name}&lt;/em&gt;!&lt;/span&gt;`);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if((G.agenda||"").includes("Gates open more often")) { if(Math.random()&lt;0.5) { const L2=locRandom().id; if(!G.gates.includes(L2)){ G.gates.push(L2); log(`&lt;span class="bad"&gt;A second gate tears open at &lt;em&gt;${locById(L2).name}&lt;/em&gt;!&lt;/span&gt;`); } } }</p>
<p class="p1"><span class="Apple-converted-space">  </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">    </span>advanceDoom(); // duplicate pressure</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p1">function spawnMonster(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>const L = G.gates.length? G.gates[rnd(G.gates.length)] : locRandom().id;</p>
<p class="p1"><span class="Apple-converted-space">  </span>const m = Object.assign({id: crypto.randomUUID(), loc:L}, MONSTERS[rnd(MONSTERS.length)]);</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.monsters.push(m);</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;span class="bad"&gt;A ${m.name} emerges at &lt;em&gt;${locById(L).name}&lt;/em&gt;.&lt;/span&gt;`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p1">function advanceDoom(n=1){</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.doom = clamp(G.doom+n,0,G.doomMax);</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;span class="bad"&gt;&lt;strong&gt;Doom +${n}&lt;/strong&gt; (${G.doom}/${G.doomMax})&lt;/span&gt;`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(G.doom&gt;=G.doomMax){ defeat("The Ancient Horror awakens. The city is lost."); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">}</p>
<p class="p1">function moveMonsters(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>// Simple AI: 50% move towards Ashen Square, else stay</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.monsters.forEach(m=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(Math.random()&lt;0.5){ m.loc="square"; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p1"><span class="Apple-converted-space">  </span>// If monsters share space with investigators, auto-engage for damage</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.players.forEach(p=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">    </span>const threats = G.monsters.filter(m=&gt;m.loc===p.loc);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(threats.length){</p>
<p class="p1"><span class="Apple-converted-space">      </span>const total = threats.reduce((s,m)=&gt;s+m.horror,0);</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(total&gt;0){ p.sanity = clamp(p.sanity-total,0,10); log(`&lt;span class="bad"&gt;${p.name} loses ${total} Sanity from looming horrors.&lt;/span&gt;`); checkDefeat(p); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function resolveEncounter(p, L, text){</p>
<p class="p1"><span class="Apple-converted-space">  </span>const skillTest = (stat, diff) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const base = p.stats[stat] + (p.focus===stat?1:0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>const {hits,rolls} = dice(base,5);</p>
<p class="p1"><span class="Apple-converted-space">    </span>log(`${p.name} tests &lt;strong&gt;${stat}&lt;/strong&gt; (need ${diff}). Rolls [${rolls.join(', ')}] → &lt;strong&gt;${hits}&lt;/strong&gt; hits.`);</p>
<p class="p1"><span class="Apple-converted-space">    </span>return hits&gt;=diff;</p>
<p class="p1"><span class="Apple-converted-space">  </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("Gain 1 Clue")){ p.clues++; log(`&lt;span class="good"&gt;${p.name} gains 1 Clue.&lt;/span&gt;`); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("Recover 2 Health")){ p.health=clamp(p.health+2,0,10); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("Recover 2 Sanity")){ p.sanity=clamp(p.sanity+2,0,10); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("lose 1 Sanity")){ p.sanity=clamp(p.sanity-1,0,10); checkDefeat(p); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("lose 1 Clue") &amp;&amp; p.clues&gt;0){ p.clues--; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("discard 1 Item") &amp;&amp; p.items.length){ p.items.pop(); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("draw a Spell")){ p.spells.push("Ward of Dusk"); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("gain Ally")){ p.items.push("Ally: Streetwise"); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("Pay 1 Health")){ p.health=clamp(p.health-1,0,10); checkDefeat(p); if(p.health&gt;0){ p.items.push("Relic: Brine Coin"); } }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("become Delayed")){ p.delayed=true; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("Will(")){ const d=+text.match(/Will\((\d)\)/)[1]; if(!skillTest("Will",d)){ if(text.includes("Doom +1")) advanceDoom(1); } }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("Intellect(")){ const d=+text.match(/Intellect\((\d)\)/)[1]; if(skillTest("Intellect",d)) { p.clues++; log(`&lt;span class="good"&gt;${p.name} discovers a Clue.&lt;/span&gt;`); } }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("Agility(")){ const d=+text.match(/Agility\((\d)\)/)[1]; if(!skillTest("Agility",d)) { p.delayed=true; log(`${p.name} is Delayed.`); } }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(text.includes("Fight(")){ const d=+text.match(/Fight\((\d)\)/)[1]; if(!skillTest("Fight",d)) { p.health=clamp(p.health-1,0,10); log(`&lt;span class="bad"&gt;${p.name} suffers 1 damage.&lt;/span&gt;`); checkDefeat(p); } }</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function checkDefeat(p){</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(p.health&lt;=0){ defeat(`${p.name} is defeated (Health).`); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(p.sanity&lt;=0){ defeat(`${p.name} is lost to madness.`); }</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function defeat(reason){</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;strong style="color:#fda4af"&gt;Defeat:&lt;/strong&gt; ${reason}`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>alert("Defeat: "+reason);</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">function victory(){</p>
<p class="p1"><span class="Apple-converted-space">  </span>alert("Victory! Doom track sealed and no open gates!");</p>
<p class="p1">}</p>
<p class="p2"><br></p>
<p class="p1">/*** Player-facing Buttons ***/</p>
<p class="p1">$("#btn-new").onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">  </span>const n = parseInt(prompt("Number of investigators (1-4)?","2")||"2",10);</p>
<p class="p1"><span class="Apple-converted-space">  </span>createPlayers(clamp(n,1,4));</p>
<p class="p1"><span class="Apple-converted-space">  </span>resetBoard();</p>
<p class="p1"><span class="Apple-converted-space">  </span>// Seed a few clues</p>
<p class="p1"><span class="Apple-converted-space">  </span>for(let i=0;i&lt;3;i++) addClue(locRandom().id);</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;strong&gt;New game:&lt;/strong&gt; ${G.players.length} investigators begin at Ashen Square.`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">};</p>
<p class="p1">$("#btn-save").onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">  </span>localStorage.setItem("greyhaven_save", JSON.stringify(G));</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;span class="good"&gt;Game saved.&lt;/span&gt;`);</p>
<p class="p1">};</p>
<p class="p1">$("#btn-load").onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">  </span>const raw = localStorage.getItem("greyhaven_save");</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(!raw){ alert("No save found."); return; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>const saved = JSON.parse(raw);</p>
<p class="p1"><span class="Apple-converted-space">  </span>Object.assign(G, saved);</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`&lt;span class="good"&gt;Game loaded.&lt;/span&gt;`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">};</p>
<p class="p1">$("#btn-help").onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">  </span>alert([</p>
<p class="p1"><span class="Apple-converted-space">    </span>"Nightfall in Greyhaven — Quick Rules:",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"• Phases each round: Upkeep → Move → Encounter → Mythos.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"• Move phase: click any location to move your active investigator (up to 2 steps; Agenda may limit to 1).",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"• Encounter phase: click Encounter to resolve an event at your location.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"• Mythos phase: the city fights back — gates, monsters, clues, and doom.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"• Use Search/Clue to try to pick up a clue at your space; Fight/Evade to engage monsters there; Rest to heal 1/1.",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"• Win by finishing Mythos with Doom low and no open gates (small game: if Doom ≤ 3 at Turn ≥ 10 and no gates, you win).",</p>
<p class="p1"><span class="Apple-converted-space">    </span>"• Hot-seat: switch Active Player with the P1/P2 buttons on the right."</p>
<p class="p1"><span class="Apple-converted-space">  </span>].join("\n"));</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">$("#btn-upkeep").onclick = ()=&gt;doUpkeep();</p>
<p class="p1">$("#btn-move").onclick <span class="Apple-converted-space">  </span>= ()=&gt;doMove();</p>
<p class="p1">$("#btn-enc").onclick<span class="Apple-converted-space">    </span>= ()=&gt;doEncounter();</p>
<p class="p1">$("#btn-mythos").onclick = ()=&gt;doMythos();</p>
<p class="p2"><br></p>
<p class="p1">$("#btn-search").onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">  </span>const p=G.players[G.active];</p>
<p class="p1"><span class="Apple-converted-space">  </span>const c = takeClue(p.loc);</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(c){ p.clues++; log(`&lt;span class="good"&gt;${p.name} collects a clue.&lt;/span&gt;`); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>else { log(`${p.name} searches but finds nothing.`); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">};</p>
<p class="p1">$("#btn-fight").onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">  </span>const p=G.players[G.active];</p>
<p class="p1"><span class="Apple-converted-space">  </span>const foes = G.monsters.filter(m=&gt;m.loc===p.loc);</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(!foes.length){ log(`${p.name} has no enemies here.`); return; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>// Attempt fight, if fail try evade</p>
<p class="p1"><span class="Apple-converted-space">  </span>const m = foes[0];</p>
<p class="p1"><span class="Apple-converted-space">  </span>const atk = dice(p.stats.Fight + (p.focus==="Fight"?1:0),5);</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`${p.name} attacks ${m.name}: rolls [${atk.rolls.join(', ')}] → ${atk.hits} hits.`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(atk.hits &gt;= m.hp){</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Defeat monster</p>
<p class="p1"><span class="Apple-converted-space">    </span>G.monsters = G.monsters.filter(x=&gt;x.id!==m.id);</p>
<p class="p1"><span class="Apple-converted-space">    </span>log(`&lt;span class="good"&gt;${p.name} defeats the ${m.name}!&lt;/span&gt;`);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(Math.random()&lt;0.4){ p.clues++; log(`&lt;span class="good"&gt;${p.name} gains 1 Clue from the trophy.&lt;/span&gt;`); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Monster strikes back</p>
<p class="p1"><span class="Apple-converted-space">    </span>p.health = clamp(p.health - m.dmg, 0, 10);</p>
<p class="p1"><span class="Apple-converted-space">    </span>p.sanity = clamp(p.sanity - m.horror, 0, 10);</p>
<p class="p1"><span class="Apple-converted-space">    </span>log(`&lt;span class="bad"&gt;${m.name} hits back: -${m.dmg} HP, -${m.horror} SAN.&lt;/span&gt;`);</p>
<p class="p1"><span class="Apple-converted-space">    </span>checkDefeat(p);</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Evade chance</p>
<p class="p1"><span class="Apple-converted-space">    </span>const ev = dice(p.stats.Agility + (p.focus==="Agility"?1:0),5);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(ev.hits &gt;= m.evade){ log(`${p.name} evades to an adjacent space.`); p.loc = "train"; } // simple escape</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">};</p>
<p class="p1">$("#btn-rest").onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">  </span>const p=G.players[G.active];</p>
<p class="p1"><span class="Apple-converted-space">  </span>p.health = clamp(p.health+1,0,10);</p>
<p class="p1"><span class="Apple-converted-space">  </span>p.sanity = clamp(p.sanity+1,0,10);</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`${p.name} rests and recovers &lt;span class="good"&gt;+1 HP&lt;/span&gt; and &lt;span class="good"&gt;+1 SAN&lt;/span&gt;.`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">};</p>
<p class="p1">$("#btn-endturn").onclick = ()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">  </span>// small victory condition</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(G.turn&gt;=10 &amp;&amp; G.doom&lt;=3 &amp;&amp; G.gates.length===0){ victory(); return; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>// pass to next player</p>
<p class="p1"><span class="Apple-converted-space">  </span>G.active = (G.active+1)%G.players.length;</p>
<p class="p1"><span class="Apple-converted-space">  </span>log(`Active player is now &lt;strong&gt;${G.players[G.active].name}&lt;/strong&gt;.`);</p>
<p class="p1"><span class="Apple-converted-space">  </span>render();</p>
<p class="p1">};</p>
<p class="p2"><br></p>
<p class="p1">// Mythos side buttons</p>
<p class="p1">$("#btn-spawn").onclick = ()=&gt;spawnGate();</p>
<p class="p1">$("#btn-dropclue").onclick = ()=&gt;dropClue();</p>
<p class="p1">$("#btn-advance").onclick = ()=&gt;advanceDoom(1);</p>
<p class="p2"><br></p>
<p class="p1">// Initial boot (auto new game for convenience)</p>
<p class="p1">createPlayers(2);</p>
<p class="p1">resetBoard();</p>
<p class="p1">for(let i=0;i&lt;3;i++) addClue(locRandom().id);</p>
<p class="p1">log(`&lt;strong&gt;New game:&lt;/strong&gt; 2 investigators begin at Ashen Square.`);</p>
<p class="p1">render();</p>
<p class="p2"><br></p>
<p class="p1">&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
